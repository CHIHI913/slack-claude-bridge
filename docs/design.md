# Slack Ã— Claude Code é€£æº è¨­è¨ˆæ›¸

## 1. å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Slack       â”‚
â”‚ (ç‰¹å®šãƒãƒ£ãƒ³ãƒãƒ«)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ WebSocket (Socket Mode)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Bridge (Node.js)          â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚       Slack Bot Client      â”‚    â”‚
â”‚  â”‚   - å—ä¿¡ / æŠ•ç¨¿             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                 â”‚                   â”‚
â”‚                 â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚      Claude Executor        â”‚    â”‚
â”‚  â”‚                             â”‚    â”‚
â”‚  â”‚  - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† (Map)      â”‚    â”‚
â”‚  â”‚  - Terminalèµ·å‹• (AppleScript)â”‚    â”‚
â”‚  â”‚  - ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«çµŒç”±ã§å‡ºåŠ›å–å¾— â”‚    â”‚
â”‚  â”‚  - session_id æŠ½å‡ºãƒ»ä¿å­˜     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ AppleScript â†’ Terminal
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Terminal.app             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  claude -p "..." > tmpfile   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

### 2.1 Slack Bot Client

**è²¬å‹™**: Slackã‚¤ãƒ™ãƒ³ãƒˆã®å—ä¿¡ã¨æŠ•ç¨¿

**ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: `@slack/bolt` (Socket Modeå¯¾å¿œ)

**ä¸»è¦æ©Ÿèƒ½**:
- Socket Mode ã§ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡
- `message` ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- ã‚¹ãƒ¬ãƒƒãƒ‰ã¸ã®è¿”ä¿¡æŠ•ç¨¿

### 2.2 Claude Executor

**è²¬å‹™**: Claude Code CLI ã®å®Ÿè¡Œ + ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

**ä¸»è¦æ©Ÿèƒ½**:
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªMap: thread_ts â†’ session_idï¼‰
- Terminalèµ·å‹•ï¼ˆAppleScriptçµŒç”±ï¼‰
- æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹: `claude -p "..." --output-format json`
- ã‚»ãƒƒã‚·ãƒ§ãƒ³å†é–‹: `claude -p "..." --resume <session_id> --output-format json`
- ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«çµŒç”±ã§ã®å‡ºåŠ›å–å¾—
- session_id ã®æŠ½å‡ºãƒ»ä¿å­˜

## 3. ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

### 3.1 ã‚»ãƒƒã‚·ãƒ§ãƒ³å¯¾å¿œè¡¨ï¼ˆã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªï¼‰

```typescript
// ClaudeExecutorå†…ã®Map
private sessions: Map<string, string> = new Map();
// key: thread_ts
// value: claude_session_id
```

**ç‰¹å¾´**:
- ãƒ—ãƒ­ã‚»ã‚¹å†èµ·å‹•æ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã¯å¤±ã‚ã‚Œã‚‹
- ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…ã‚’å„ªå…ˆ
- æ°¸ç¶šåŒ–ãŒå¿…è¦ãªå ´åˆã¯JSONãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚’è¿½åŠ å¯èƒ½

### 3.2 Claude Code å‡ºåŠ› (--output-format json)

```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "result": "ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ...",
  "usage": {
    "input_tokens": 100,
    "output_tokens": 200
  }
}
```

## 4. å‡¦ç†ãƒ•ãƒ­ãƒ¼

### 4.1 æ–°è¦ã‚¹ãƒ¬ãƒƒãƒ‰ï¼ˆè¦ªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰

```
1. Slack message ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡
2. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
   - å¯¾è±¡ãƒãƒ£ãƒ³ãƒãƒ«ã‹ï¼Ÿ â†’ No: ç„¡è¦–
   - botæŠ•ç¨¿ã‹ï¼Ÿ â†’ Yes: ç„¡è¦–
   - thread_ts ã‚ã‚Šï¼Ÿ â†’ Yes: 4.2ã¸
3. TerminalçµŒç”±ã§Claude Codeæ–°è¦å®Ÿè¡Œ
   - AppleScriptã§Terminalèµ·å‹•
   - claude -p "..." --output-format json > tmpfile
4. ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã—ã¦çµæœå–å¾—
5. session_idã‚’ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªMapã«ä¿å­˜
   key: thread_ts (= message.ts)
6. Slack ã‚¹ãƒ¬ãƒƒãƒ‰ã«è¿”ä¿¡æ¡ˆã‚’æŠ•ç¨¿
```

### 4.2 ã‚¹ãƒ¬ãƒƒãƒ‰å†…è¿”ä¿¡

```
1. Slack message ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡
2. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
   - å¯¾è±¡ãƒãƒ£ãƒ³ãƒãƒ«ã‹ï¼Ÿ â†’ No: ç„¡è¦–
   - botæŠ•ç¨¿ã‹ï¼Ÿ â†’ Yes: ç„¡è¦–
   - thread_ts ã‚ã‚Šï¼Ÿ â†’ No: 4.1ã¸
3. ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªMapã‹ã‚‰ session_id å–å¾—
   - è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ: ã‚¨ãƒ©ãƒ¼ï¼ˆæ–°è¦ã¨ã—ã¦æ‰±ã‚ãªã„ï¼‰
4. TerminalçµŒç”±ã§Claude Codeå†é–‹å®Ÿè¡Œ
   - claude -p "..." --resume <session_id> --output-format json > tmpfile
5. ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã—ã¦çµæœå–å¾—
6. Slack ã‚¹ãƒ¬ãƒƒãƒ‰ã«è¿”ä¿¡æ¡ˆã‚’æŠ•ç¨¿
```

## 5. Claude Code å®Ÿè¡Œè©³ç´°

### 5.1 å®Ÿè¡Œæ–¹å¼

**Terminal + ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«æ–¹å¼**ã‚’æ¡ç”¨:
1. AppleScriptã§Terminal.appã‚’èµ·å‹•
2. claudeã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€å‡ºåŠ›ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
3. "DONE"ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½è¨˜ã—ã¦å®Œäº†ã‚’é€šçŸ¥
4. Node.jså´ã§ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã—ã¦çµæœã‚’å–å¾—

**ç†ç”±**:
- node-ptyãŒmacOSã§å‹•ä½œã—ãªã„å•é¡Œã‚’å›é¿
- Claude CLIãŒTTYã‚’å¿…è¦ã¨ã™ã‚‹å ´åˆã§ã‚‚å‹•ä½œ
- å®Ÿè¡Œä¸­ã®Claudeã®çŠ¶æ…‹ãŒTerminalã§å¯è¦–åŒ–ã•ã‚Œã‚‹

### 5.2 æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³

```bash
claude -p '<user_message>' \
  --append-system-prompt '<system_prompt>' \
  --output-format json > /tmp/claude-output-<thread_ts>.json 2>&1
echo "DONE" >> /tmp/claude-output-<thread_ts>.json
```

### 5.3 ã‚»ãƒƒã‚·ãƒ§ãƒ³å†é–‹

```bash
claude -p '<user_message>' \
  --resume '<session_id>' \
  --output-format json > /tmp/claude-output-<thread_ts>.json 2>&1
echo "DONE" >> /tmp/claude-output-<thread_ts>.json
```

### 5.4 AppleScriptå®Ÿè¡Œ

```javascript
const appleScript = `
  tell application "Terminal"
    activate
    do script "${fullCmd}"
  end tell
`;
exec(`osascript -e '${appleScript}'`);
```

### 5.5 å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ç›£è¦–ãƒ»session_idæŠ½å‡º

```javascript
// ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’1ç§’é–“éš”ã§ãƒãƒ¼ãƒªãƒ³ã‚°
const content = await fs.readFile(outputFile, 'utf-8');
if (content.includes('DONE')) {
  const jsonContent = content.replace(/DONE\s*$/, '').trim();
  const response = JSON.parse(jsonContent);
  const sessionId = response.session_id;
  const result = response.result;
}
```

## 6. SlackæŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

```
è¿”ä¿¡æ¡ˆï¼ˆãƒ‰ãƒ©ãƒ•ãƒˆï¼‰ğŸ‘‡

<ClaudeãŒç”Ÿæˆã—ãŸãƒ†ã‚­ã‚¹ãƒˆ>
```

## 7. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

| ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ | å¯¾å¿œ |
|-----------|------|
| Claudeå®Ÿè¡Œã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | ãƒ­ã‚°è¨˜éŒ²ã€SlackæŠ•ç¨¿ã—ãªã„ |
| Terminalèµ·å‹•å¤±æ•— | ãƒ­ã‚°è¨˜éŒ²ã€SlackæŠ•ç¨¿ã—ãªã„ |
| JSONè§£æå¤±æ•— | ç”Ÿãƒ†ã‚­ã‚¹ãƒˆã‚’çµæœã¨ã—ã¦ä½¿ç”¨ |
| session_id å–å¾—å¤±æ•—ï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰è¿”ä¿¡æ™‚ï¼‰ | ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‡ºåŠ›ã€å‡¦ç†ã‚¹ã‚­ãƒƒãƒ— |
| SlackæŠ•ç¨¿å¤±æ•— | ãƒ­ã‚°è¨˜éŒ²ã®ã¿ |
| ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•— | å†è©¦è¡Œï¼ˆãƒãƒ¼ãƒªãƒ³ã‚°ç¶™ç¶šï¼‰ |

## 8. è¨­å®šé …ç›®

```javascript
const config = {
  // Slack
  slackBotToken: process.env.SLACK_BOT_TOKEN,
  slackAppToken: process.env.SLACK_APP_TOKEN,  // Socket Modeç”¨
  targetChannelId: process.env.TARGET_CHANNEL_ID,

  // Claude
  claudeWorkingDir: process.env.CLAUDE_WORKING_DIR || process.cwd(),
  claudeTimeout: 120000,  // 2åˆ†ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
};
```

## 9. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
slack-claude-bridge/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts           # ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ slack-client.ts    # Slack Bot Client
â”‚   â”œâ”€â”€ claude-executor.ts # Claude Executor + Sessionç®¡ç†
â”‚   â””â”€â”€ config.ts          # è¨­å®š
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ requirements.md    # è¦ä»¶å®šç¾©æ›¸
â”‚   â””â”€â”€ design.md          # è¨­è¨ˆæ›¸
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ .env                   # ç’°å¢ƒå¤‰æ•°
```

## 10. æŠ€è¡“é¸å®š

| é …ç›® | é¸å®š | ç†ç”± |
|------|------|------|
| è¨€èª | TypeScript | å‹å®‰å…¨ã€ã‚¨ãƒ©ãƒ¼æ¤œå‡º |
| Slack SDK | @slack/bolt | Socket Modeå¯¾å¿œã€å…¬å¼ |
| ãƒ—ãƒ­ã‚»ã‚¹å®Ÿè¡Œ | child_process.exec + AppleScript | TerminalçµŒç”±ã§å¯è¦–åŒ–ã€TTYå•é¡Œã‚’å›é¿ |
| çŠ¶æ…‹ç®¡ç† | ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªMap | ã‚·ãƒ³ãƒ—ãƒ«ã€å†èµ·å‹•æ™‚ã®æ¶ˆå¤±ã¯è¨±å®¹ |
| å‡ºåŠ›å–å¾— | ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ« + ãƒãƒ¼ãƒªãƒ³ã‚° | éåŒæœŸå®Ÿè¡Œã«å¯¾å¿œ |

## 11. åˆ¶é™äº‹é …ãƒ»æ—¢çŸ¥ã®å•é¡Œ

| é …ç›® | å†…å®¹ |
|------|------|
| macOSå°‚ç”¨ | AppleScriptã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚macOSã§ã®ã¿å‹•ä½œ |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³æ°¸ç¶šåŒ–ãªã— | ãƒ—ãƒ­ã‚»ã‚¹å†èµ·å‹•ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒæ¶ˆå¤± |
| TerminalãŒå¿…è¦ | å®Ÿè¡Œä¸­ã«Terminal.appãŒé–‹ã |
